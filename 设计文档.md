# UnifiScrapy 设计文档

## 项目概述

UnifiScrapy是一个专门设计用于爬取Ubiquiti产品发布信息的Python爬虫项目。项目使用GraphQL API技术从官方社区网站获取最新的产品版本发布信息，并将其结构化存储到MongoDB数据库中，便于后续的数据分析和处理。

## 技术栈

- **编程语言**：Python 3.8+
- **数据存储**：MongoDB 4.0+
- **API技术**：GraphQL
- **HTTP客户端**：Requests库
- **数据解析**：JSON处理
- **配置管理**：环境变量（dotenv）
- **日志记录**：Python标准库logging
- **并发处理**：异步请求

## 系统架构

UnifiScrapy采用模块化设计，将不同功能划分为独立的模块，便于维护和扩展。系统主要包含以下核心模块：

### 核心模块

1. **models.py**：数据模型定义
   - 定义`UnifiRelease`数据模型
   - 提供数据验证和转换方法
   - 支持序列化和反序列化

2. **storage.py**：数据存储层
   - 提供MongoDB连接管理
   - 实现数据的CRUD操作
   - 支持增量更新和冲突处理
   - 处理断点续传的检查点存储

3. **graphql_scraper.py**：GraphQL API爬虫
   - 封装GraphQL API请求
   - 实现分页逻辑
   - 处理API响应解析
   - 提供错误重试机制

4. **utils.py**：工具函数
   - 提供日志记录工具
   - 实现检查点管理
   - 提供通用的帮助函数
   - 处理日期和版本号解析

### 数据流设计

1. **数据获取流程**：
   ```
   初始化 → 加载检查点 → GraphQL请求产品列表 → 
   过滤已处理项 → 获取产品详情 → 数据处理 → 
   保存到数据库 → 更新检查点
   ```

2. **错误处理流程**：
   ```
   请求发送 → 异常捕获 → 重试策略 → 
   错误记录 → 恢复机制
   ```

3. **检查点管理流程**：
   ```
   启动加载 → 定期保存 → 备份机制 → 恢复逻辑
   ```

## GraphQL API设计

### API端点

所有GraphQL请求都发送到同一端点：
```
https://community.svc.ui.com/
```

### 主要查询类型

1. **产品列表查询**：使用分页参数，获取基本产品信息
   ```graphql
   query {
     releases(limit: 50, offset: 0) {
       items {
         id
         slug
         title
         version
         # 更多字段...
       }
     }
   }
   ```

2. **产品详情查询**：使用产品ID获取完整信息
   ```graphql
   query GetRelease($id: ID!) {
     release(id: $id) {
       id
       title
       version
       releaseDate
       downloadLinks {
         name
         url
       }
       releaseNotes {
         improvements
         bugfixes
         knownIssues
       }
       # 更多字段...
     }
   }
   ```

### 查询优化

1. **使用Fragment**：复用查询片段，减少代码重复
2. **字段选择**：只请求需要的字段，减少数据传输
3. **批处理**：适当批量获取数据，减少请求次数

## 数据模型设计

### UnifiRelease模型

主要字段：

- `product_name`：产品名称
- `version`：版本号
- `release_date`：发布日期
- `release_id`：唯一标识符
- `release_notes`：发布说明
- `download_links`：下载链接列表
- `firmware_type`：固件类型
- `is_beta`：是否为测试版本
- `tags`：标签列表
- `improvements`：改进列表
- `bugfixes`：修复的问题
- `known_issues`：已知问题
- `created_at`：记录创建时间
- `last_updated`：记录更新时间

## 增量更新机制

系统通过以下方式实现增量更新：

1. **检查点机制**：记录已处理的产品ID和位置
2. **去重逻辑**：基于唯一标识符过滤已处理项
3. **智能更新**：对已存在记录进行差异更新
4. **时间戳控制**：使用last_updated字段跟踪更新

## 错误处理策略

1. **网络请求错误**：
   - 实现指数退避重试
   - 设置请求超时
   - 记录请求失败日志

2. **数据解析错误**：
   - 提供健壮的JSON解析
   - 使用默认值处理缺失字段
   - 记录解析异常情况

3. **数据库错误**：
   - 实现事务处理
   - 提供回滚机制
   - 保持数据一致性

## 性能优化

1. **请求优化**：
   - 批量处理请求
   - 控制请求频率
   - 优化查询结构

2. **数据库优化**：
   - 创建适当索引
   - 批量插入操作
   - 连接池管理

3. **内存管理**：
   - 控制数据批处理大小
   - 及时释放不需要的对象
   - 避免不必要的大对象复制

## 扩展性考虑

1. **模块化设计**：
   - 核心功能分离到独立模块
   - 采用接口抽象设计
   - 支持替换具体实现

2. **配置灵活性**：
   - 外部化配置参数
   - 支持运行时参数调整
   - 提供合理默认值

3. **功能扩展性**：
   - 预留插件接口
   - 支持自定义处理器
   - 提供事件钩子机制 